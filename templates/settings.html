<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>EchoMosaic Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
  function triggerUpdate() {
    window.location.href = '/update';
  }
  function triggerRollback() {
    if (!confirm('Roll back to previous version?')) return;
    fetch('/rollback_app', {
      method: 'POST',
      headers: { 'X-API-Key': '{{ config.get("API_KEY", "") }}' }
    })
    .then(res => res.text())
    .then(html => { document.body.innerHTML = html; })
    .catch(err => alert('Rollback failed: ' + err));
  }
  function loadUpdateInfo() {
    fetch('/update_info', { headers: { 'X-API-Key': '{{ config.get("API_KEY", "") }}' }})
      .then(r => r.json())
      .then(info => {
        const el = (id, v) => document.getElementById(id).textContent = v || '-';
        el('branch', info.branch);
        el('current', info.current_desc || info.current_commit);
        el('remote', info.remote_desc || info.remote_commit);
        el('previous', info.previous_desc || info.previous_commit || 'None');
        const btn = document.getElementById('update-btn');
        const note = document.getElementById('update-note');
        if (info.update_available) {
          btn.disabled = false;
          note.textContent = 'Update available';
        } else {
          btn.disabled = true;
          note.textContent = 'Up to date';
        }
        const rb = document.getElementById('rollback-btn');
        rb.disabled = !info.previous_commit;
      });
  }
  document.addEventListener('DOMContentLoaded', loadUpdateInfo);
  async function loadUpdateHistory() {
    const list = document.getElementById('history-list');
    if (!list) return;
    list.innerHTML = '<li style="opacity:0.8; padding:6px 8px;">Loading…</li>';
    try {
      const res = await fetch('/update_history', { headers: { 'X-API-Key': '{{ config.get("API_KEY", "") }}' }});
      const data = await res.json();
      const items = (data.history||[]).slice().reverse();
      if (!items.length) { list.innerHTML = '<li style="opacity:0.8; padding:6px 8px;">No updates recorded yet.</li>'; return; }
      list.innerHTML = '';
      items.forEach(ent => {
        const li = document.createElement('li');
        li.style.padding = '6px 8px';
        li.style.borderBottom = '1px solid var(--border)';
        const ts = ent.timestamp ? new Date(ent.timestamp).toLocaleString() : '';
        const branch = ent.branch || '';
        const from = ent.from_desc || '(none)';
        const to = ent.to_desc || '(unknown)';
        li.textContent = `${ts} [${branch}] ${from} → ${to}`;
        list.appendChild(li);
      });
    } catch (e) {
      list.innerHTML = '<li style="color:#f66; padding:6px 8px;">Failed to load history</li>';
    }
  }
  document.addEventListener('DOMContentLoaded', loadUpdateHistory);
  </script>
</head>
<body>
  <header class="top-bar">
    <h1>Settings</h1>
    <nav>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <button id="theme-toggle" class="icon-btn" type="button" aria-label="Toggle theme" title="Toggle theme" style="margin-left:.5rem;"></button>
    </nav>
  </header>
  <div class="container">
    <p><strong>Install Dir:</strong> {{ config.INSTALL_DIR }}</p>
    <p><strong>Service Name:</strong> {{ config.SERVICE_NAME }}</p>
    <p><strong>Update Branch:</strong> {{ config.UPDATE_BRANCH }}</p>
    <div style="margin: 1rem 0; padding: 0.75rem; border:1px solid var(--border); border-radius:4px; background: var(--surface-alt);">
      <h3 style="margin-top:0;">Update Status</h3>
      <p><strong>Branch:</strong> <span id="branch">-</span></p>
      <p><strong>Current:</strong> <span id="current">-</span></p>
      <p><strong>Latest:</strong> <span id="remote">-</span></p>
      <p><strong>Previous:</strong> <span id="previous">-</span></p>
      <p id="update-note" style="opacity:0.9;">Checking…</p>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button id="update-btn" onclick="triggerUpdate()" disabled>Update Now</button>
        <button id="rollback-btn" onclick="triggerRollback()" disabled>Rollback</button>
      </div>
    </div>

    <div style="margin: 1rem 0; padding: 0.75rem; border:1px solid var(--border); border-radius:4px; background: var(--surface-alt);">
      <h3 style="margin-top:0;">Update History</h3>
      <div id="history" style="max-height: 280px; overflow-y: auto; border:1px solid var(--border); border-radius:4px; background: var(--surface);">
        <ul id="history-list" style="list-style:none; margin:0; padding:0;"></ul>
      </div>
    </div>

    <div style="margin: 1rem 0; padding: 0.75rem; border:1px solid var(--border); border-radius:4px; background: var(--surface-alt);">
      <h3 style="margin-top:0;">Stable Horde Defaults</h3>
      <p style="margin-top:0;">These values seed AI image settings when a stream switches to AI mode without custom preferences.</p>
      <textarea id="ai-defaults-editor" style="width:100%; min-height:200px; font-family:monospace; font-size:0.9rem; line-height:1.4; padding:0.5rem; border:1px solid var(--border); border-radius:4px; background:var(--surface); color:inherit;">{{ ai_defaults|tojson(indent=2) }}</textarea>
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-top:0.5rem;">
        <button type="button" id="ai-defaults-save">Save Defaults</button>
        <button type="button" id="ai-defaults-reset">Reset to Fallback</button>
        <span id="ai-defaults-status" style="opacity:0.9;"></span>
      </div>
    </div>

    <div style="margin: 1rem 0; padding: 0.75rem; border:1px solid var(--border); border-radius:4px; background: var(--surface-alt);">
      <h3 style="margin-top:0;">Backup / Restore</h3>
      <p style="margin-top:0;">Export or import your dashboard streams, groups, layout and notes.</p>
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
        <a href="/settings/export" download>
          <button type="button">Export Settings</button>
        </a>
        <input type="file" id="import-file" accept="application/json">
        <button type="button" id="import-btn">Import</button>
        <span id="import-status" style="opacity:.9;"></span>
      </div>
    </div>

  </div>
  <script>
  (function(){
    const root = document.documentElement;
    const btn = document.getElementById('theme-toggle');
    function apply(theme){
      const t = (theme === 'light') ? 'light' : 'dark';
      root.setAttribute('data-theme', t);
      if (btn) btn.textContent = t === 'light' ? '☀️' : '🌙';
    }
    const saved = localStorage.getItem('theme') || 'dark';
    apply(saved);
    if (btn) btn.addEventListener('click', () => {
      const cur = root.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      apply(next);
      try { localStorage.setItem('theme', next); } catch(e){}
    });
  })();
  </script>
  <script>
  (function(){
    const editor = document.getElementById('ai-defaults-editor');
    const saveBtn = document.getElementById('ai-defaults-save');
    const resetBtn = document.getElementById('ai-defaults-reset');
    const status = document.getElementById('ai-defaults-status');
    const fallback = {{ ai_fallback_defaults|tojson }};
    if (!editor || !saveBtn) return;

    const setStatus = (msg, ok = true) => {
      if (!status) return;
      status.textContent = msg;
      status.style.color = ok ? 'inherit' : '#f77';
    };

    const parseEditor = () => {
      try {
        return JSON.parse(editor.value || '{}');
      } catch (err) {
        setStatus('Invalid JSON: ' + err.message, false);
        return null;
      }
    };

    saveBtn.addEventListener('click', async () => {
      const payload = parseEditor();
      if (!payload) return;
      setStatus('Saving…');
      try {
        const res = await fetch('/settings/ai-defaults', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.status !== 'success') {
          setStatus(data.error || 'Failed to save defaults', false);
          return;
        }
        editor.value = JSON.stringify(data.defaults, null, 2);
        setStatus('Defaults saved');
      } catch (err) {
        setStatus('Failed to save defaults', false);
      }
    });

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        editor.value = JSON.stringify(fallback, null, 2);
        setStatus('Fallback defaults loaded');
      });
    }
  })();
  </script>
  <script>
  // Backup/Restore import handler
  (function(){
    const btn = document.getElementById('import-btn');
    const inp = document.getElementById('import-file');
    const status = document.getElementById('import-status');
    if (!btn || !inp) return;
    btn.addEventListener('click', async () => {
      if (status) status.textContent = '';
      if (!inp.files || !inp.files[0]) { alert('Pick a JSON file to import'); return; }
      const fd = new FormData();
      fd.append('file', inp.files[0]);
      try {
        const res = await fetch('/settings/import', { method:'POST', body: fd });
        if (res.ok) {
          if (status) status.textContent = 'Imported. Reloading…';
          setTimeout(()=> location.href = '/', 600);
        } else {
          const j = await res.json().catch(()=>({}));
          if (status) status.textContent = (j && j.error) ? j.error : 'Import failed';
        }
      } catch (e) {
        if (status) status.textContent = 'Import failed';
      }
    });
  })();
  </script>
</body>
</html>
