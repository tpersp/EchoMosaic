<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>EchoMosaic Debug Logs</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      background: var(--bg);
      color: var(--text);
    }
    .debug-page {
      max-width: 960px;
      margin: 1.5rem auto;
      padding: 1.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(0,0,0,0.45);
    }
    .debug-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .debug-header h1 {
      margin: 0;
      font-size: 1.85rem;
    }
    .debug-meta {
      font-size: 0.9rem;
      opacity: 0.85;
    }
    .debug-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .debug-controls button,
    .debug-controls a.button-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #d0d0d0;
      text-decoration: none;
      transition: background 0.2s, border 0.2s, color 0.2s;
      cursor: pointer;
    }
    .debug-controls button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .debug-controls button:hover:not(:disabled),
    .debug-controls a.button-link:hover {
      background: #3c3c3c;
      border-color: #4c4c4c;
      color: #ffffff;
    }
    .log-output {
      background: #1b1b1b;
      color: #d0d0d0;
      font-family: 'Fira Mono', 'Consolas', 'SFMono-Regular', monospace;
      font-size: 0.85rem;
      line-height: 1.4;
      padding: 0.75rem;
      border-radius: 4px;
      border: 1px solid #303030;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.35);
      height: 70vh;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-info { color: #33b5e5; }
    .log-warning { color: #ffd740; }
    .log-error { color: #ff5252; }
    .log-debug { color: #9e9e9e; }
    .log-generic { color: #e0e0e0; }
    .timestamp { color: #888888; }
    .log-link {
      color: #64b5f6;
      text-decoration: underline;
    }
    .log-link:hover {
      color: #90caf9;
    }
    .status-bar {
      margin-bottom: 0.75rem;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      background: rgba(79, 163, 255, 0.12);
      border: 1px solid rgba(79, 163, 255, 0.35);
      font-size: 0.85rem;
    }
    .status-bar[data-state="error"] {
      background: rgba(220, 53, 69, 0.15);
      border-color: rgba(220, 53, 69, 0.45);
    }
    .status-bar[data-state="warn"] {
      background: rgba(255, 193, 7, 0.15);
      border-color: rgba(255, 193, 7, 0.45);
    }
    nav.debug-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      font-size: 0.9rem;
    }
    nav.debug-nav a {
      color: var(--accent);
      text-decoration: none;
    }
    nav.debug-nav a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="debug-page">
    <nav class="debug-nav">
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <span aria-hidden="true">/</span>
      <span>Debug</span>
    </nav>
    <header class="debug-header">
      <h1>Service Logs</h1>
      <div class="debug-meta">
        Monitoring <code>{{ service_name }}</code>.
        Log level: <strong>{{ (logging_config.get("level") or "INFO") }}</strong>,
        retention target: {{ (logging_config.get("retention_days") or 7) }} days.
        Initial view loads the last {{ default_initial_lines }} lines.
      </div>
    </header>
    <div id="log-status" class="status-bar" data-state="info">Connecting to journal…</div>
    <div class="debug-controls">
      <button type="button" id="pause-btn">Pause</button>
      <button type="button" id="resume-btn" disabled>Resume</button>
      <a class="button-link" href="{{ url_for('debug_download') }}" download>Download Logs</a>
    </div>
    <pre id="log-output" class="log-output" aria-live="polite"></pre>
  </div>
  <script>
    const logOutput = document.getElementById('log-output');
    const statusBar = document.getElementById('log-status');
    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const MAX_LINES = 2000;

    let evtSource = null;
    let isPaused = false;
    const buffer = [];

    const setStatus = (message, state = 'info') => {
      statusBar.textContent = message;
      statusBar.dataset.state = state;
    };

    const renderBuffer = () => {
      logOutput.innerHTML = buffer.join('\n');
      logOutput.scrollTop = logOutput.scrollHeight;
    };

    const pushLine = (line) => {
      buffer.push(line);
      if (buffer.length > MAX_LINES) {
        buffer.splice(0, buffer.length - MAX_LINES);
      }
      renderBuffer();
    };

    const closeStream = () => {
      if (evtSource) {
        evtSource.close();
        evtSource = null;
      }
    };

    const startStream = (includeInitial = true) => {
      closeStream();
      const params = includeInitial ? '' : '?initial=0';
      evtSource = new EventSource(`/api/debug/stream${params}`);
      isPaused = false;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      evtSource.onopen = () => setStatus('Streaming live journal output.', 'info');
      evtSource.onmessage = (event) => {
        pushLine(event.data);
      };
      evtSource.addEventListener('error', () => {
        if (!evtSource) {
          return;
        }
        if (evtSource.readyState === EventSource.CONNECTING) {
          setStatus('Connection interrupted – attempting to reconnect…', 'warn');
        } else {
          setStatus('Stream closed by server.', 'error');
          closeStream();
          pauseBtn.disabled = true;
          resumeBtn.disabled = false;
        }
      });
    };

    pauseBtn.addEventListener('click', () => {
      if (isPaused) {
        return;
      }
      isPaused = true;
      closeStream();
      setStatus('Stream paused.', 'warn');
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    });

    resumeBtn.addEventListener('click', () => {
      if (!isPaused) {
        return;
      }
      setStatus('Reconnecting…', 'info');
      startStream(false);
    });

    window.addEventListener('beforeunload', () => {
      closeStream();
    });

    startStream(true);
  </script>
</body>
</html>
