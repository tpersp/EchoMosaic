<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Updating EchoMosaic…</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .progress { height: 10px; background: #333; border-radius: 6px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.6s ease; }
    .steps { list-style: none; padding: 0; margin: 0.5rem 0 0; }
    .steps li { opacity: 0.7; margin: 0.25rem 0; }
    .steps li.active { opacity: 1; color: var(--text); }
    .steps li.done { opacity: 0.9; }
  </style>
</head>
<body>
  <header class="top-bar">
    <h1>Updating…</h1>
    <nav>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
    </nav>
  </header>
  <div class="container">
    <p>We’re applying the latest update. This may take a minute.</p>
    <div class="progress"><div id="bar" class="bar"></div></div>
    <ul id="steps" class="steps">
      <li class="active">Fetching latest code</li>
      <li>Checking out branch</li>
      <li>Applying update</li>
      <li>Updating dependencies</li>
      <li>Restarting service</li>
      <li>Waiting for restart</li>
    </ul>
    <p id="status" style="margin-top:0.5rem; opacity:0.9;">Starting…</p>
  </div>
  <script>
    const steps = Array.from(document.querySelectorAll('#steps li'));
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');

    let i = 0;
    function advance(msg) {
      if (i < steps.length) {
        steps[i].classList.remove('active');
        steps[i].classList.add('done');
      }
      i = Math.min(i + 1, steps.length - 1);
      steps[i].classList.add('active');
      bar.style.width = Math.round(((i) / (steps.length)) * 100) + '%';
      if (msg) statusEl.textContent = msg;
    }

    // Animate progress locally while the server does real work
    const msgs = [
      'Fetching latest code…',
      'Switching to update branch…',
      'Applying updates…',
      'Updating dependencies…',
      'Restarting service…',
      'Waiting for restart…'
    ];
    let t = 0;
    function tick() { if (t < msgs.length) { advance(msgs[t++]); setTimeout(tick, 900); } }
    setTimeout(tick, 500);

    // Kick off update; when done, finalize and redirect
    const headers = {};
    {% if api_key %}headers['X-API-Key'] = '{{ api_key }}';{% endif %}
    fetch('/update_app', { method: 'POST', headers })
      .then(r => r.text())
      .then(txt => {
        const lower = txt.toLowerCase();
        const isError = lower.includes('failed') || lower.includes('unauthorized') || lower.includes('error');
        if (isError) {
          statusEl.textContent = 'Update encountered an error. See details below.';
          const detail = document.createElement('div');
          detail.style.marginTop = '0.75rem';
          detail.innerHTML = txt;
          document.querySelector('.container').appendChild(detail);
          return;
        }
        // Start restart wait loop
        waitForRestart();
      })
      .catch(err => {
        statusEl.textContent = 'Update failed: ' + err;
      });

    function waitForRestart() {
      // Move to last step UI-wise
      while (i < steps.length - 1) { advance('Waiting for restart…'); }
      const start = Date.now();
      let attempts = 0;
      const maxWaitMs = 120000; // 2 minutes
      const tick = async () => {
        attempts++;
        statusEl.textContent = `Waiting for restart… (attempt ${attempts})`;
        try {
          const res = await fetch('/health', { cache: 'no-store' });
          if (res.ok) {
            bar.style.width = '100%';
            statusEl.textContent = 'Back online. Redirecting…';
            setTimeout(() => { window.location.href = '/'; }, 1200);
            return;
          }
        } catch (e) { /* ignore; server may be down */ }
        if (Date.now() - start > maxWaitMs) {
          statusEl.textContent = 'Taking longer than usual. You can try refreshing the dashboard.';
          const link = document.createElement('a');
          link.href = '/';
          link.textContent = 'Go to Dashboard';
          link.style.marginLeft = '8px';
          statusEl.appendChild(link);
          return;
        }
        setTimeout(tick, Math.min(5000, 500 + attempts * 200));
      };
      setTimeout(tick, 1000);
    }
  </script>
</body>
</html>
